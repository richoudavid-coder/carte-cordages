<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Cartes Cordage">
    <title>Cartes Cordage Pro</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const Icons = {
            Users: () => (
                <svg className="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
            ),
            Plus: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                </svg>
            ),
            CreditCard: () => (
                <svg className="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                </svg>
            ),
            CheckCircle: () => (
                <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            ),
            Circle: () => (
                <svg className="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10" strokeWidth={2} />
                </svg>
            ),
            Trash2: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            ),
            Edit2: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
            ),
            Save: () => (
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                </svg>
            ),
            Search: () => (
                <svg className="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            ),
            Award: () => (
                <svg className="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" />
                </svg>
            )
        };

        window.storage = {
            get: async (key) => {
                const value = localStorage.getItem(key);
                return value ? { key, value } : null;
            },
            set: async (key, value) => {
                localStorage.setItem(key, value);
                return { key, value };
            },
            delete: async (key) => {
                localStorage.removeItem(key);
                return { key, deleted: true };
            },
            list: async (prefix) => {
                const keys = Object.keys(localStorage).filter(k => k.startsWith(prefix));
                return { keys };
            }
        };

        function EditClientForm({ client, onSave, onCancel }) {
            const [formData, setFormData] = useState({
                nom: client.nom,
                prenom: client.prenom,
                telephone: client.telephone || '',
                email: client.email || ''
            });

            const handleSubmit = () => {
                if (!formData.nom || !formData.prenom) {
                    alert('Le nom et pr√©nom sont obligatoires');
                    return;
                }
                onSave(formData);
            };

            return (
                <div className="bg-gradient-to-br from-amber-50 to-orange-50 p-6 rounded-xl border-2 border-amber-300">
                    <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <Icons.Edit2 />
                        Modifier le client
                    </h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-1">Nom *</label>
                            <input type="text" value={formData.nom}
                                onChange={(e) => setFormData({...formData, nom: e.target.value})}
                                className="w-full border-2 border-gray-300 rounded-lg px-4 py-2" />
                        </div>
                        <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-1">Pr√©nom *</label>
                            <input type="text" value={formData.prenom}
                                onChange={(e) => setFormData({...formData, prenom: e.target.value})}
                                className="w-full border-2 border-gray-300 rounded-lg px-4 py-2" />
                        </div>
                        <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-1">T√©l√©phone</label>
                            <input type="tel" value={formData.telephone}
                                onChange={(e) => setFormData({...formData, telephone: e.target.value})}
                                className="w-full border-2 border-gray-300 rounded-lg px-4 py-2" />
                        </div>
                        <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-1">Email</label>
                            <input type="email" value={formData.email}
                                onChange={(e) => setFormData({...formData, email: e.target.value})}
                                className="w-full border-2 border-gray-300 rounded-lg px-4 py-2" />
                        </div>
                    </div>
                    <div className="flex gap-3">
                        <button onClick={handleSubmit}
                            className="bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-2 rounded-lg flex items-center gap-2 shadow-lg font-semibold">
                            <Icons.Save />
                            Enregistrer
                        </button>
                        <button onClick={onCancel}
                            className="bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-2 rounded-lg font-semibold">
                            Annuler
                        </button>
                    </div>
                </div>
            );
        }

        function App() {
            const [clients, setClients] = useState([]);
            const [showAddForm, setShowAddForm] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [editingClientId, setEditingClientId] = useState(null);
            const [newClient, setNewClient] = useState({
                nom: '', prenom: '', telephone: '', email: ''
            });

            useEffect(() => { loadClients(); }, []);

            const loadClients = async () => {
                try {
                    const result = await window.storage.list('client:');
                    if (result?.keys) {
                        const data = await Promise.all(
                            result.keys.map(async (key) => {
                                try {
                                    const d = await window.storage.get(key);
                                    return d ? JSON.parse(d.value) : null;
                                } catch { return null; }
                            })
                        );
                        setClients(data.filter(c => c).sort((a, b) => 
                            new Date(b.dateCreation) - new Date(a.dateCreation)
                        ));
                    }
                } catch { console.log('Premi√®re utilisation'); }
            };

            const saveClient = async (client) => {
                try {
                    await window.storage.set(`client:${client.id}`, JSON.stringify(client));
                    await loadClients();
                } catch { alert('Erreur sauvegarde'); }
            };

            const handleAddClient = async () => {
                if (!newClient.nom || !newClient.prenom) {
                    alert('Nom et pr√©nom obligatoires');
                    return;
                }
                const client = {
                    id: Date.now().toString(),
                    ...newClient,
                    cartes: [],
                    dateCreation: new Date().toISOString()
                };
                await saveClient(client);
                setNewClient({ nom: '', prenom: '', telephone: '', email: '' });
                setShowAddForm(false);
            };

            const handleTogglePose = async (clientId, carteIdx, poseIdx) => {
                const client = clients.find(c => c.id === clientId);
                const updated = { ...client };
                
                if (updated.cartes[carteIdx].poses[poseIdx]) {
                    updated.cartes[carteIdx].poses[poseIdx] = null;
                } else {
                    updated.cartes[carteIdx].poses[poseIdx] = {
                        date: new Date().toISOString(),
                        cordage: '', tension: ''
                    };
                    const used = updated.cartes[carteIdx].poses.filter(p => p).length;
                    const left = 10 - used;
                    if (left === 3) alert(`üéæ Il reste 3 poses pour ${client.prenom} ${client.nom} !`);
                    if (left === 0) alert(`‚úÖ Carte compl√®te pour ${client.prenom} ${client.nom} !\nLes 10 poses ont √©t√© utilis√©es.`);
                }
                await saveClient(updated);
            };

            const handleAddCarte = async (clientId, sport) => {
                const client = clients.find(c => c.id === clientId);
                await saveClient({
                    ...client,
                    cartes: [...client.cartes, {
                        id: Date.now().toString(),
                        sport: sport,
                        dateAchat: new Date().toISOString(),
                        poses: Array(10).fill(null)
                    }]
                });
            };

            const handleDeleteClient = async (clientId) => {
                if (confirm('Supprimer ce client ?')) {
                    try {
                        await window.storage.delete(`client:${clientId}`);
                        await loadClients();
                    } catch { alert('Erreur suppression'); }
                }
            };

            const handleDeleteCarte = async (clientId, carteIdx) => {
                if (confirm('Supprimer cette carte ?')) {
                    const client = clients.find(c => c.id === clientId);
                    await saveClient({
                        ...client,
                        cartes: client.cartes.filter((_, idx) => idx !== carteIdx)
                    });
                }
            };

            const handleEditClient = (client) => {
                setEditingClientId(client.id);
            };

            const handleSaveEdit = async (clientId, updatedInfo) => {
                const client = clients.find(c => c.id === clientId);
                await saveClient({ ...client, ...updatedInfo });
                setEditingClientId(null);
            };

            const handleCancelEdit = () => {
                setEditingClientId(null);
            };

            const handleUpdatePoseDetails = async (clientId, carteIdx, poseIdx, field, value) => {
                const client = clients.find(c => c.id === clientId);
                const updated = { ...client };
                if (updated.cartes[carteIdx].poses[poseIdx]) {
                    updated.cartes[carteIdx].poses[poseIdx][field] = value;
                    await saveClient(updated);
                }
            };

            const filtered = clients.filter(c => {
                const s = searchTerm.toLowerCase();
                return c.nom.toLowerCase().includes(s) || 
                       c.prenom.toLowerCase().includes(s) ||
                       (c.telephone?.includes(searchTerm)) ||
                       (c.email?.toLowerCase().includes(s));
            });

            const cartesTennis = clients.reduce((sum, c) => 
                sum + c.cartes.filter(carte => carte.sport === 'tennis').length, 0
            );
            const cartesBadminton = clients.reduce((sum, c) => 
                sum + c.cartes.filter(carte => carte.sport === 'badminton').length, 0
            );
            const totalPoses = clients.reduce((sum, c) => 
                sum + c.cartes.reduce((s, carte) => 
                    s + carte.poses.filter(p => p).length, 0
                ), 0
            );

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                    <div className="max-w-7xl mx-auto">
                        <div className="bg-white rounded-xl shadow-xl p-6 mb-6">
                            <div className="flex flex-col md:flex-row items-center justify-between gap-4">
                                <div className="flex items-center gap-4">
                                    <div className="bg-gradient-to-br from-indigo-600 to-purple-600 p-4 rounded-xl shadow-lg">
                                        <Icons.CreditCard />
                                    </div>
                                    <div>
                                        <h1 className="text-3xl font-bold text-gray-800">Cartes Cordage Pro</h1>
                                        <p className="text-gray-600">Tennis & Badminton</p>
                                    </div>
                                </div>
                                <button onClick={() => setShowAddForm(!showAddForm)}
                                    className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-3 rounded-lg flex items-center gap-2 shadow-lg">
                                    <Icons.Plus />
                                    Nouveau Client
                                </button>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
                                <div className="bg-blue-100 p-4 rounded-lg">
                                    <p className="text-blue-600 text-sm font-semibold">Clients</p>
                                    <p className="text-3xl font-bold text-blue-800">{clients.length}</p>
                                </div>
                                <div className="bg-green-100 p-4 rounded-lg">
                                    <p className="text-green-600 text-sm font-semibold">üéæ Tennis</p>
                                    <p className="text-3xl font-bold text-green-800">{cartesTennis}</p>
                                </div>
                                <div className="bg-orange-100 p-4 rounded-lg">
                                    <p className="text-orange-600 text-sm font-semibold">üè∏ Badminton</p>
                                    <p className="text-3xl font-bold text-orange-800">{cartesBadminton}</p>
                                </div>
                                <div className="bg-purple-100 p-4 rounded-lg">
                                    <p className="text-purple-600 text-sm font-semibold">Poses</p>
                                    <p className="text-3xl font-bold text-purple-800">{totalPoses}</p>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white rounded-xl shadow-lg p-4 mb-6">
                            <div className="relative">
                                <Icons.Search />
                                <input type="text" placeholder="Rechercher..." value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="w-full pl-10 pr-4 py-3 border rounded-lg" />
                            </div>
                        </div>

                        {showAddForm && (
                            <div className="bg-white rounded-xl shadow-xl p-6 mb-6 border-2 border-indigo-200">
                                <h2 className="text-2xl font-bold mb-4">Nouveau Client</h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <input type="text" placeholder="Nom *" value={newClient.nom}
                                        onChange={(e) => setNewClient({...newClient, nom: e.target.value})}
                                        className="border-2 rounded-lg px-4 py-3" />
                                    <input type="text" placeholder="Pr√©nom *" value={newClient.prenom}
                                        onChange={(e) => setNewClient({...newClient, prenom: e.target.value})}
                                        className="border-2 rounded-lg px-4 py-3" />
                                    <input type="tel" placeholder="T√©l√©phone" value={newClient.telephone}
                                        onChange={(e) => setNewClient({...newClient, telephone: e.target.value})}
                                        className="border-2 rounded-lg px-4 py-3" />
                                    <input type="email" placeholder="Email" value={newClient.email}
                                        onChange={(e) => setNewClient({...newClient, email: e.target.value})}
                                        className="border-2 rounded-lg px-4 py-3" />
                                </div>
                                <div className="flex gap-3 mt-6">
                                    <button onClick={handleAddClient}
                                        className="bg-green-600 text-white px-8 py-3 rounded-lg font-semibold">
                                        Cr√©er
                                    </button>
                                    <button onClick={() => setShowAddForm(false)}
                                        className="bg-gray-300 text-gray-800 px-8 py-3 rounded-lg font-semibold">
                                        Annuler
                                    </button>
                                </div>
                            </div>
                        )}

                        <div className="space-y-6">
                            {filtered.length === 0 ? (
                                <div className="bg-white rounded-xl shadow-xl p-12 text-center">
                                    <Icons.Users />
                                    <p className="text-gray-600 text-xl font-semibold mt-4">
                                        {searchTerm ? 'Aucun client trouv√©' : 'Aucun client'}
                                    </p>
                                </div>
                            ) : (
                                filtered.map(client => (
                                    <div key={client.id} className="bg-white rounded-xl shadow-xl p-6">
                                        {editingClientId === client.id ? (
                                            <EditClientForm client={client}
                                                onSave={(info) => handleSaveEdit(client.id, info)}
                                                onCancel={handleCancelEdit} />
                                        ) : (
                                            <>
                                                <div className="flex flex-col md:flex-row justify-between mb-6 gap-4">
                                                    <div>
                                                        <h3 className="text-2xl font-bold">{client.prenom} {client.nom}</h3>
                                                        {client.telephone && <p className="text-gray-600">üì± {client.telephone}</p>}
                                                        {client.email && <p className="text-gray-600">‚úâÔ∏è {client.email}</p>}
                                                    </div>
                                                    <div className="flex gap-2 flex-wrap">
                                                        <button onClick={() => handleEditClient(client)}
                                                            className="bg-amber-600 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                                                            <Icons.Edit2 />
                                                            Modifier
                                                        </button>
                                                        <button onClick={() => handleAddCarte(client.id, 'tennis')}
                                                            className="bg-green-600 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                                                            <Icons.Plus />
                                                            üéæ Tennis
                                                        </button>
                                                        <button onClick={() => handleAddCarte(client.id, 'badminton')}
                                                            className="bg-orange-600 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                                                            <Icons.Plus />
                                                            üè∏ Badminton
                                                        </button>
                                                        <button onClick={() => handleDeleteClient(client.id)}
                                                            className="bg-red-600 text-white p-2 rounded-lg">
                                                            <Icons.Trash2 />
                                                        </button>
                                                    </div>
                                                </div>

                                                <div className="space-y-4">
                                                    {client.cartes.length === 0 ? (
                                                        <div className="bg-gray-50 border-2 border-dashed rounded-xl p-8 text-center">
                                                            <Icons.CreditCard />
                                                            <p className="text-gray-600 font-semibold mt-3">Aucune carte</p>
                                                        </div>
                                                    ) : (
                                                        client.cartes.map((carte, carteIdx) => {
                                                            const used = carte.poses.filter(p => p).length;
                                                            const prog = (used / 10) * 100;
                                                            const isTennis = carte.sport === 'tennis';
                                                            
                                                            return (
                                                                <div key={carte.id} className={`border-2 rounded-xl p-5 ${
                                                                    isTennis ? 'border-green-200 bg-green-50' : 'border-orange-200 bg-orange-50'
                                                                }`}>
                                                                    <div className="flex justify-between mb-4">
                                                                        <h4 className="font-bold text-lg">
                                                                            {isTennis ? 'üéæ' : 'üè∏'} Carte #{carteIdx + 1}
                                                                        </h4>
                                                                        <div className="flex items-center gap-4">
                                                                            <span className={`font-bold ${isTennis ? 'text-green-600' : 'text-orange-600'}`}>
                                                                                {used}/10
                                                                            </span>
                                                                            <span className="text-sm text-gray-600">
                                                                                {new Date(carte.dateAchat).toLocaleDateString('fr-FR')}
                                                                            </span>
                                                                            <button onClick={() => handleDeleteCarte(client.id, carteIdx)}
                                                                                className="bg-red-600 text-white p-2 rounded-lg">
                                                                                <Icons.Trash2 />
                                                                            </button>
                                                                        </div>
                                                                    </div>

                                                                    <div className="mb-4">
                                                                        <div className="w-full bg-gray-200 rounded-full h-3">
                                                                            <div className={`h-3 rounded-full ${
                                                                                isTennis ? 'bg-green-600' : 'bg-orange-600'
                                                                            }`} style={{width: `${prog}%`}} />
                                                                        </div>
                                                                    </div>

                                                                    <div className="grid grid-cols-2 md:grid-cols-5 gap-3">
                                                                        {carte.poses.map((pose, poseIdx) => (
                                                                            <div key={poseIdx}>
                                                                                <button onClick={() => handleTogglePose(client.id, carteIdx, poseIdx)}
                                                                                    className={`w-full p-4 rounded-xl border-2 ${
                                                                                        pose 
                                                                                            ? `${isTennis ? 'bg-green-500' : 'bg-orange-500'} text-white`
                                                                                            : 'bg-white'
                                                                                    }`}>
                                                                                    <div className="text-center">
                                                                                        {pose ? <Icons.CheckCircle /> : <Icons.Circle />}
                                                                                        <div className="font-bold text-sm mt-2">Pose {poseIdx + 1}</div>
                                                                                        {pose && (
                                                                                            <div className="text-xs mt-1">
                                                                                                {new Date(
                                                                                              {used === 7 && (
                                                                    <div className={`mt-4 border-2 rounded-xl p-4 text-center ${
                                                                        isTennis ? 'bg-yellow-100 border-yellow-400' : 'bg-red-100 border-red-400'
                                                                    }`}>
                                                                        <p className="font-bold">‚ö†Ô∏è Plus que 3 poses !</p>
                                                                    </div>
                                                                )}

                                                                {used === 10 && (
                                                                    <div className={`mt-4 border-2 rounded-xl p-4 text-center ${
                                                                        isTennis ? 'bg-green-100 border-green-400' : 'bg-orange-100 border-orange-400'
                                                                    }`}>
                                                                        <p className="font-bold">‚úÖ Carte compl√®te !</p>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        );
                                                    })
                                                )}
                                            </div>
                                        </>
                                    )}
                                </div>
                            ))
                        )}
                    </div>
                </div>
            </div>
        );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
</script>
